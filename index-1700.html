<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Kereta Sesuai Gaji Bersih RM1700</title>
  <style>
    :root{
      --page-max-width:1100px;
      --card-bg:#fff;
      --card-border:#e6e6e6;
      --gold:#d7a52a;
      --text:#111;
      --thumb-height:220px;
      --thumb-radius:10px;
    }
    html,body{height:100%;margin:0;background:#fafafa;color:var(--text);font-family:Arial,Helvetica,sans-serif}
    .wrap{max-width:var(--page-max-width);margin:0 auto;padding:14px}
    .hero{
      display:flex;align-items:center;justify-content:center;
      background:linear-gradient(90deg,var(--gold), #f3c95b);
      color:#111;font-weight:800;padding:18px 12px;border-radius:10px;margin-bottom:18px;
      box-shadow:0 6px 18px rgba(0,0,0,0.06);
      text-align:center;
    }
    .hero h1{margin:0;font-size:18px}
    .brand-group{margin-bottom:22px}
    .brand-title{font-weight:800;letter-spacing:0.6px;margin:4px 0 8px}
    .divider{height:1px;background:linear-gradient(90deg,#eee,#fff);margin-bottom:10px;border-radius:2px}
    .grid{display:flex;flex-direction:column;gap:14px}
    .card{
      background:var(--card-bg);
      border:1px solid var(--card-border);
      border-radius:10px;padding:12px;box-sizing:border-box;display:flex;flex-direction:column;gap:10px;
    }
    .thumb-wrap{width:100%;overflow:hidden;border-radius:var(--thumb-radius);}
    .thumb-wrap img{width:100%;height:var(--thumb-height);object-fit:cover;display:block;border-radius:var(--thumb-radius);}
    .car-title{font-weight:700;margin:0;font-size:15px}
    .car-otr{font-weight:700;margin:0}
    .car-month{color:#444;margin:0}
    .card-footer{display:flex;justify-content:flex-start;gap:10px;align-items:center}
    .btn{
      display:inline-block;padding:8px 10px;border-radius:8px;background:#0077ff;color:#fff;text-decoration:none;font-weight:700;font-size:13px;
    }
    .msg{padding:12px;background:#fff;border-radius:8px;box-shadow:0 6px 18px rgba(0,0,0,0.04);text-align:center}
    @media (max-width:420px){
      :root{--page-max-width:100%}
      .wrap{padding:12px}
    }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="hero">
      <h1 id="pageTitle">Kereta Sesuai Gaji Bersih RM1700</h1>
    </div>

    <div id="content">
      <div id="loading" class="msg">⏳ Memuatkan senarai kereta…</div>
      <div id="carsContainer"></div>
    </div>
  </div>

  <script>
  (async () => {
    // --- CONFIG: change these when copying file for other nettpay pages ---
    const NETTPAY_AMOUNT = 1700;   // update for each file
    const MAX_OTR = 35000;         // update for each file
    const API_CARS = 'https://autopass-backend.onrender.com/cars';
    // ----------------------------------------------------------------------

    const loadingEl = document.getElementById('loading');
    const carsContainer = document.getElementById('carsContainer');
    const pageTitle = document.getElementById('pageTitle');
    pageTitle.textContent = `Kereta Sesuai Gaji Bersih RM${NETTPAY_AMOUNT}`;

    function safeNum(n){
      if (n === undefined || n === null || n === '') return null;
      const num = Number(String(n).replace(/[^0-9.-]/g,''));
      if (Number.isNaN(num)) return null;
      return num;
    }
    function fmt(n){
      const v = safeNum(n);
      return v === null ? null : v.toLocaleString();
    }

    try {
      const res = await fetch(API_CARS, { cache:'no-cache' });
      if (!res.ok) throw new Error(`API ${res.status}`);
      const cars = await res.json();

      // Filter by OTR <= MAX_OTR
      const filtered = (cars || []).filter(c => {
        const otrNum = safeNum(c.OTR);
        return otrNum !== null && otrNum <= MAX_OTR;
      });

      if (!filtered.length) {
        loadingEl.textContent = 'Tiada kereta untuk julat ini.';
        return;
      }

      // Sort: Brand -> Model -> Spec -> Year desc
      filtered.sort((a,b) => {
        const brandCompare = (a.Brand ?? '').localeCompare(b.Brand ?? '');
        if (brandCompare !== 0) return brandCompare;
        const modelCompare = (a.Model ?? '').localeCompare(b.Model ?? '');
        if (modelCompare !== 0) return modelCompare;
        const specCompare = (a.Spec ?? '').localeCompare(b.Spec ?? '');
        if (specCompare !== 0) return specCompare;
        return (b.Year ?? 0) - (a.Year ?? 0);
      });

      // Group by brand (uppercase)
      const groups = filtered.reduce((acc, car) => {
        const brand = (car.Brand || 'Unknown').toUpperCase();
        if (!acc[brand]) acc[brand] = [];
        acc[brand].push(car);
        return acc;
      }, {});

      // Render groups (full-width cards)
      carsContainer.innerHTML = '';
      for (const brand of Object.keys(groups)) {
        const groupEl = document.createElement('section');
        groupEl.className = 'brand-group';

        const title = document.createElement('div');
        title.className = 'brand-title';
        title.textContent = brand;
        groupEl.appendChild(title);

        const divider = document.createElement('div');
        divider.className = 'divider';
        groupEl.appendChild(divider);

        const grid = document.createElement('div');
        grid.className = 'grid';

        for (const car of groups[brand]) {
          const card = document.createElement('article');
          card.className = 'card';

          // Thumbnail (1.jpg)
          const thumbWrap = document.createElement('div');
          thumbWrap.className = 'thumb-wrap';
          const img = document.createElement('img');
          img.loading = 'lazy';
          // image path (1.jpg) — assumes folder /gallery/<plate>/1.jpg as discussed
          const plateEncoded = encodeURIComponent(car.PlateNumber || '');
          img.src = `https://raw.githubusercontent.com/auto-pass/gallery/main/${plateEncoded}/1.jpg`;
          img.alt = `${car.PlateNumber || ''} cover`;
          img.onerror = () => { img.style.display = 'none'; };
          thumbWrap.appendChild(img);
          card.appendChild(thumbWrap);

          // Title line
          const titleEl = document.createElement('div');
          titleEl.className = 'car-title';
          titleEl.textContent = `${(car.Brand||'').toUpperCase()} ${(car.Model||'').toUpperCase()} ${(car.Spec||'').toUpperCase()} ${car.Year||''}`.trim();
          card.appendChild(titleEl);

          // OTR line (hide if missing)
          const otrFormatted = fmt(car.OTR);
          if (otrFormatted !== null) {
            const otrEl = document.createElement('div');
            otrEl.className = 'car-otr';
            otrEl.textContent = `RM${otrFormatted}`;
            card.appendChild(otrEl);
          }

          // Monthly & Tenure (3-line)
          const monthly = (car.Monthly || '').toString().trim();
          const tenure = (car.Tenure || '').toString().trim();
          if (monthly || tenure) {
            const monthEl = document.createElement('div');
            monthEl.className = 'car-month';
            let txt = '';
            if (monthly) txt += `Bulanan ${monthly}`;
            if (tenure) txt += (txt ? ' utk ' : '') + `${tenure} tahun`;
            monthEl.textContent = txt;
            card.appendChild(monthEl);
          }

          // View photos link (opens version 1 gallery) — include return param
          const footer = document.createElement('div');
          footer.className = 'card-footer';
          const a = document.createElement('a');
          a.className = 'btn';
          a.href = `https://auto-pass.github.io/gallery/?plate=${plateEncoded}&return=${NETTPAY_AMOUNT}`;
          a.textContent = 'LIHAT GAMBAR';
          footer.appendChild(a);
          card.appendChild(footer);

          grid.appendChild(card);
        }

        groupEl.appendChild(grid);
        carsContainer.appendChild(groupEl);
      }

      loadingEl.style.display = 'none';
    } catch (err) {
      loadingEl.textContent = `❌ ${err.message}`;
    }
  })();
  </script>
</body>
</html>
